name: Generate Changelog from CodeRabbit

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to generate changelog for'
        required: true

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}
          fetch-depth: 0

      - name: Set PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Request CodeRabbit On-Demand Report
        id: request-report
        run: |
          RESPONSE=$(curl -X POST https://api.coderabbit.ai/api/v1/reports/on-demand \
            -H "api-key: ${{ secrets.CR_API }}" \
            -H "Content-Type: application/json" \
            -d '{
              "repository": "${{ github.repository }}",
              "pull_number": ${{ steps.pr-number.outputs.pr_number }},
              "report_type": "changelog",
              "format": "markdown"
            }')
          
          echo "Response: $RESPONSE"
          
          # Extract request_id from response
          REQUEST_ID=$(echo $RESPONSE | jq -r '.request_id')
          echo "request_id=$REQUEST_ID" >> $GITHUB_OUTPUT
          
          if [ "$REQUEST_ID" = "null" ] || [ -z "$REQUEST_ID" ]; then
            echo "Failed to get request_id from CodeRabbit API"
            exit 1
          fi

      - name: Wait for Report Generation
        id: get-report
        run: |
          REQUEST_ID="${{ steps.request-report.outputs.request_id }}"
          MAX_ATTEMPTS=30
          ATTEMPT=0
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            echo "Checking report status (attempt $((ATTEMPT+1))/$MAX_ATTEMPTS)..."
            
            RESPONSE=$(curl -X GET "https://api.coderabbit.ai/api/v1/reports/on-demand/$REQUEST_ID" \
              -H "api-key: ${{ secrets.CR_API }}")
            
            STATUS=$(echo $RESPONSE | jq -r '.status')
            echo "Status: $STATUS"
            
            if [ "$STATUS" = "completed" ]; then
              echo "Report generation completed!"
              REPORT_CONTENT=$(echo $RESPONSE | jq -r '.report.content')
              
              # Save to file for next step
              echo "$REPORT_CONTENT" > /tmp/changelog_content.md
              echo "report_ready=true" >> $GITHUB_OUTPUT
              break
            elif [ "$STATUS" = "failed" ]; then
              echo "Report generation failed"
              echo "Response: $RESPONSE"
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT+1))
          done
          
          if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
            echo "Timeout waiting for report generation"
            exit 1
          fi

      - name: Create/Update CHANGELOG.md
        if: steps.get-report.outputs.report_ready == 'true'
        run: |
          # Read the generated content
          CONTENT=$(cat /tmp/changelog_content.md)
          
          # Get PR details for header
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ steps.pr-number.outputs.pr_number }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          DATE=$(date +"%Y-%m-%d")
          
          # Create or update CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # Prepend to existing changelog
            {
              echo "## PR #$PR_NUMBER - $PR_TITLE"
              echo ""
              echo "**Date:** $DATE"
              echo "**Author:** @$PR_AUTHOR"
              echo ""
              echo "$CONTENT"
              echo ""
              echo "---"
              echo ""
              cat CHANGELOG.md
            } > CHANGELOG.md.tmp
            mv CHANGELOG.md.tmp CHANGELOG.md
          else
            # Create new changelog
            {
              echo "# Changelog"
              echo ""
              echo "## PR #$PR_NUMBER - $PR_TITLE"
              echo ""
              echo "**Date:** $DATE"
              echo "**Author:** @$PR_AUTHOR"
              echo ""
              echo "$CONTENT"
            } > CHANGELOG.md
          fi

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add CHANGELOG.md
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update CHANGELOG.md from CodeRabbit analysis"
            git push
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… CHANGELOG.md has been updated with insights from CodeRabbit analysis.'
            })
